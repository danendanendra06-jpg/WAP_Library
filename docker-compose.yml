version: '3.8'

services:
  # 1. Layanan Nginx (Web Server)
  nginx:
    image: nginx:latest # Menggunakan image Nginx (bisa diganti nginx:debian)
    ports:
      - "8080:80" # Akses di host: http://localhost:8080
    volumes:
      # 1. Mount seluruh kode proyek
      - ./:/var/www/html
      # 2. Mount file konfigurasi Nginx baru kita
      - ./nginx.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      - php # Harus menunggu PHP siap
      - db  # Harus menunggu DB siap

  # 2. Layanan PHP-FPM (Aplikasi)
  php:
    build:
      context: .
      dockerfile: Dockerfile.php # Menggunakan Dockerfile.php baru
    volumes:
      # Mount seluruh kode proyek
      - ./:/var/www/html
    depends_on:
      - db # Harus menunggu DB siap

  # 3. Layanan Database (MariaDB)
  db:
    # Menggunakan image MariaDB 10.4 (sesuai file SQL Anda)
    image: mariadb:10.4
    environment:
      MARIADB_ROOT_PASSWORD: root # Ini HARUS SAMA dengan $pass di db.php
      MARIADB_DATABASE: projek_perpus # Ini membuat database saat start
    volumes:
      # 1. Mengimpor database Anda secara otomatis saat pertama kali dijalankan
      - ./database/projek_perpus.sql:/docker-entrypoint-initdb.d/init.sql
      # 2. Menyimpan data database secara persisten
      - db_data:/var/lib/mysql
    ports:
      # (Opsional) Jika Anda ingin terhubung dari host
      - "33066:3306" 

  # 4. (Opsional) Layanan PhpMyAdmin (GUI Database)
  phpmyadmin:
    image: phpmyadmin/phpmyadmin
    ports:
      - "8081:80" # Akses di host: http://localhost:8081
    environment:
      PMA_HOST: db # Hubungkan ke layanan 'db' kita
    depends_on:
      - db

# Deklarasi volume persisten untuk database
volumes:
  db_data: