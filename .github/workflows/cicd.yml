name: CI/CD PHP (2 Jobs)

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:

  # ========================
  # JOB 1: BUILD
  # ========================
  build:
    runs-on: [laptop_husain]

    steps:
    - name: Set project path
      run: |
        PROJECT_PATH=$(find /home -name 'WAP_Library' -type d 2>/dev/null | head -1)
        if [ -z "$PROJECT_PATH" ]; then
          echo "‚ùå Folder WAP_Library tidak ditemukan"
          exit 1
        fi
        echo "PROJECT_PATH=$PROJECT_PATH" >> $GITHUB_ENV
        echo "üìÅ Found project at: $PROJECT_PATH"

    - name: Pull latest changes
      working-directory: ${{ env.PROJECT_PATH }}
      run: |
        git fetch origin master || git pull origin master
        git reset --hard origin/master
        echo "‚úî Build job selesai menarik kode terbaru"


  # ========================
  # JOB 2: DEPLOY
  # ========================
  deploy:
    runs-on: [laptop_husain]
    needs: build    # Wajib: deploy menunggu build selesai

    steps:
    - name: Stop existing containers
      working-directory: ${{ env.PROJECT_PATH }}
      run: docker compose down || true

    - name: Remove old images
      working-directory: ${{ env.PROJECT_PATH }}
      run: |
        docker system prune -f
        docker image prune -a -f

    - name: Build and start containers
      working-directory: ${{ env.PROJECT_PATH }}
      run: |
        docker compose build --no-cache
        docker compose up -d

    - name: Health check
      run: |
        curl -f http://localhost:8080 || exit 1

    - name: Notify deployment status
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "üöÄ Deploy berhasil!"
        else
          echo "‚ùå Deploy gagal!"
        fi
