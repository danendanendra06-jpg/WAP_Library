name: CI/CD Auto Pull and Rebuild

on:
  push:
    branches: [ master ]
  workflow_dispatch:

defaults:
  run:
    shell: bash

jobs:

  # ==============================
  # JOB 1: DEPLOY DI MY_LAPTOP
  # ==============================
  deploy_my_laptop:
    runs-on: [my_laptop]
    continue-on-error: false   # Laptop kamu harus berhasil
    steps:

    - name: Set project path
    run: |
      PROJECT_PATH=$(find /home -name 'WAP_Library' -type d 2>/dev/null | head -1)
      if [ -z "$PROJECT_PATH" ]; then
        echo "‚ùå Error: Folder WAP_Library tidak ditemukan"
        exit 1
      fi
      echo "PROJECT_PATH=$PROJECT_PATH" >> $GITHUB_ENV
      echo "üìÅ Project found at: $PROJECT_PATH"

    - name: Pull latest changes
      working-directory: ${{ env.PROJECT_PATH }}
      run: |
        git fetch origin master
        git reset --hard origin/master

    - name: Restart Docker Compose (aman)
      working-directory: ${{ env.PROJECT_PATH }}
      run: |
        docker compose down || true
        docker compose up -d --build

    - name: Health Check (Flexible Port)
      env:
        HEALTH_PORT: 8080
      run: |
        echo "üîç Checking service at http://localhost:$HEALTH_PORT ..."
        curl -f http://localhost:$HEALTH_PORT || echo "‚ö† Health check gagal, mungkin port berbeda."

    - name: Notify Result
      if: always()
      run: |
        echo "Status: ${{ job.status }}"
        if [ "${{ job.status }}" == "success" ]; then
          echo "‚úÖ Deployment di my_laptop berhasil!"
        else
          echo "‚ùå Deployment di my_laptop gagal!"
        fi


  # ==============================
  # JOB 2: DEPLOY DI LAPTOP HUSAIN
  # ==============================
  deploy_laptop_husain:
    runs-on: [laptop_husain]
    continue-on-error: true   # ‚Üê Job boleh gagal jika laptop Husain OFFLINE
    steps:

    - name: Set project path
      run: |
        PROJECT_PATH=$(find /home -name 'WAP_Library' -type d 2>/dev/null | head -1)
        if [ -z "$PROJECT_PATH" ]; then
          echo "‚ö† Folder project tidak ditemukan di laptop Husain (mungkin laptop OFF)"
          exit 0
        fi
        echo "PROJECT_PATH=$PROJECT_PATH" >> $GITHUB_ENV

    - name: Pull latest changes
      working-directory: ${{ env.PROJECT_PATH }}
      run: |
        git fetch origin master
        git reset --hard origin/master

    - name: Restart Docker Compose (aman)
      working-directory: ${{ env.PROJECT_PATH }}
      run: |
        docker compose down || true
        docker compose up -d --build

    - name: Health Check (Flexible Port)
      env:
        HEALTH_PORT: 8080
      run: |
        echo "üîç Checking service at http://localhost:$HEALTH_PORT ..."
        curl -f http://localhost:$HEALTH_PORT || \
          echo "‚ö† Health check gagal (port beda atau laptop mati)"

    - name: Notify Result
      if: always()
      run: |
        echo "Status: ${{ job.status }}"
        if [ "${{ job.status }}" == "success" ]; then
          echo "‚úÖ Deployment di laptop Husain berhasil!"
        else
          echo "‚ö† Laptop Husain mungkin offline ‚Äî tidak masalah."
        fi
