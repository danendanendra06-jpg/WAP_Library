name: CI/CD Auto Pull and Rebuild

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  my_laptop:
  runs-on: [my_laptop]

  steps:
  - name: Checkout repository
    uses: actions/checkout@v4

  - name: Pull latest changes
    working-directory: ${{ github.workspace }}
    run: |
      git fetch origin master
      git reset --hard origin/master

  - name: Stop existing containers
    working-directory: ${{ github.workspace }}
    run: |
      docker compose down || true

  - name: Remove old images
    run: |
      docker system prune -f
      docker image prune -a -f

  - name: Build and start containers
    working-directory: ${{ github.workspace }}
    run: |
      docker compose build --no-cache
      docker compose up -d

  - name: Wait for services to be ready
    run: |
      sleep 30
      docker compose -f ${{ github.workspace }}/docker-compose.yml ps

  - name: Health check
    run: |
      curl -f http://localhost:8080 || exit 1

  - name: Notify deployment status
    if: always()
    run: |
      if [ ${{ job.status }} == 'success' ]; then
        echo "✅ Deployment berhasil!"
      else
        echo "❌ Deployment gagal!"
      fi
laptop_husain:
  runs-on: [laptop_husain]

  steps:
  - name: Checkout repository
    uses: actions/checkout@v4

  - name: Pull latest changes
    working-directory: ${{ github.workspace }}
    run: |
      git fetch origin master
      git reset --hard origin/master

  - name: Stop existing containers
    working-directory: ${{ github.workspace }}
    run: |
      docker compose down || true

  - name: Remove old images
    run: |
      docker system prune -f
      docker image prune -a -f

  - name: Build and start containers
    working-directory: ${{ github.workspace }}
    run: |
      docker compose build --no-cache
      docker compose up -d

  - name: Wait for services to be ready
    run: |
      sleep 30
      docker compose -f ${{ github.workspace }}/docker-compose.yml ps

  - name: Health check
    run: |
      curl -f http://localhost:8080 || exit 1

  - name: Notify deployment status
    if: always()
    run: |
      if [ ${{ job.status }} == 'success' ]; then
        echo "✅ Deployment berhasil!"
      else
        echo "❌ Deployment gagal!"
      fi

